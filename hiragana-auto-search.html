<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ひらがなずらし自動検索</title>
  <style>
    body { 
      font-family: sans-serif; 
      margin: 10px;
      background-color: #fff;
    }
    
    h1 {
      margin-bottom: 10px;
    }

    #status {
      margin: 10px 0;
      font-weight: bold;
      color: #333;
    }

    #buttonContainer {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .lengthButton {
      padding: 10px 20px;
      font-size: 16px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .lengthButton:hover {
      background: #0056CC;
    }

    .lengthButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #resultContainer {
      margin-top: 20px;
    }

    #resultTitle {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .match-group {
      margin-bottom: 20px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .match-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #007AFF;
    }

    .match-list {
      margin-left: 20px;
    }

    .word-item {
      margin: 3px 0;
      padding: 5px;
      background: white;
      border-left: 3px solid #007AFF;
      padding-left: 10px;
    }

    .shift-info {
      color: #666;
      font-size: 14px;
      margin-left: 10px;
    }

    @media (min-width: 768px) {
      body {
        margin: 20px;
      }
    }
  </style>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ひらがな自動検索">
</head>
<body>
  <h1>ひらがなずらし自動検索</h1>
  
  <div id="status">CSVを読み込んでいます...</div>

  <div id="buttonContainer"></div>

  <div id="resultContainer">
    <div id="resultTitle"></div>
    <div id="resultContent"></div>
  </div>

  <hr>
  <div>
    <a href="index.html">一覧検索に戻る</a> | 
    <a href="hiragana-shift.html">ひらがなずらしへ</a>
  </div>

  <script>
    // 清音（濁点・半濁点なし）
    const seion = [
      'あ', 'い', 'う', 'え', 'お',
      'か', 'き', 'く', 'け', 'こ',
      'さ', 'し', 'す', 'せ', 'そ',
      'た', 'ち', 'つ', 'て', 'と',
      'な', 'に', 'ぬ', 'ね', 'の',
      'は', 'ひ', 'ふ', 'へ', 'ほ',
      'ま', 'み', 'む', 'め', 'も',
      'や', 'ゆ', 'よ',
      'ら', 'り', 'る', 'れ', 'ろ',
      'わ', 'を', 'ん'
    ];

    // 濁音グループ1（が〜ご、ざ〜ぞ、だ〜ど）
    const dakuon1 = [
      'が', 'ぎ', 'ぐ', 'げ', 'ご',
      'ざ', 'じ', 'ず', 'ぜ', 'ぞ',
      'だ', 'ぢ', 'づ', 'で', 'ど'
    ];

    // 濁音グループ2（ば〜ぼ）
    const dakuon2 = [
      'ば', 'び', 'ぶ', 'べ', 'ぼ'
    ];

    // 半濁音グループ
    const handakuon = [
      'ぱ', 'ぴ', 'ぷ', 'ぺ', 'ぽ'
    ];

    // 小さい文字グループ
    const chiisai = [
      'っ',
      'ゃ', 'ゅ', 'ょ'
    ];

    let wordsByLength = {}; // 文字数ごとに単語を格納
    let allWords = [];

    // ページ読み込み時
    window.addEventListener('DOMContentLoaded', () => {
      fetch('日本語一覧new.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error('CSV を読み込めませんでした: ' + response.status);
          }
          return response.text();
        })
        .then(text => {
          parseCSV(text);
          createButtons();
        })
        .catch(err => {
          document.getElementById('status').textContent = 
            '読み込みエラー: ' + err.message;
        });
    });

    // CSVパーサ
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      
      if (lines.length < 2) {
        document.getElementById('status').textContent = 'CSVが空です';
        return;
      }

      // ヘッダを確認（単語列を探す）
      const header = lines[0].split(',');
      const wordIndex = header.indexOf('単語');

      if (wordIndex === -1) {
        document.getElementById('status').textContent = 
          'CSV に「単語」列が見つかりません';
        return;
      }

      // 単語を抽出して文字数ごとに分類
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const cols = lines[i].split(',');
        const word = cols[wordIndex] ? cols[wordIndex].trim() : '';
        
        if (word && /^[あ-ん゛゜ぁぃぅぇぉゃゅょゎっー]+$/.test(word)) {
          allWords.push(word);
          const length = word.length;
          if (!wordsByLength[length]) {
            wordsByLength[length] = [];
          }
          wordsByLength[length].push(word);
        }
      }

      document.getElementById('status').textContent = 
        `読み込み完了: 全${allWords.length}単語`;
    }

    // ボタンを作成
    function createButtons() {
      const container = document.getElementById('buttonContainer');
      const lengths = Object.keys(wordsByLength).map(Number).sort((a, b) => a - b);

      if (lengths.length === 0) {
        container.innerHTML = '<p>単語が見つかりませんでした</p>';
        return;
      }

      for (const length of lengths) {
        const count = wordsByLength[length].length;
        const button = document.createElement('button');
        button.className = 'lengthButton';
        button.textContent = `${length}文字 (${count}単語)`;
        button.addEventListener('click', () => searchByLength(length));
        container.appendChild(button);
      }
    }

    // 指定文字数の検索を実行
    function searchByLength(length) {
      document.getElementById('resultTitle').textContent = 
        `${length}文字の検索結果`;
      document.getElementById('resultContent').innerHTML = 
        '<p>検索中...</p>';

      // 非同期で検索実行（画面フリーズ防止）
      setTimeout(() => {
        const matches = findMatches(length);
        displayResults(matches, length);
      }, 100);
    }

    // マッチする単語ペアを検索（最適化版）
    function findMatches(length) {
      const words = wordsByLength[length];
      const results = [];
      const processed = new Set(); // 既に処理された単語を記録

      for (let i = 0; i < words.length; i++) {
        // 既に処理済みの単語はスキップ
        if (processed.has(words[i])) {
          continue;
        }

        const matchGroup = [{word: words[i], shift: 0, base: words[i]}];
        processed.add(words[i]); // 基準単語を処理済みに追加
        
        for (let j = i + 1; j < words.length; j++) {
          // 既に処理済みの単語はスキップ
          if (processed.has(words[j])) {
            continue;
          }

          const shiftAmount = canShift(words[i], words[j]);
          if (shiftAmount !== null) {
            matchGroup.push({
              word: words[j], 
              shift: shiftAmount, 
              base: words[i]
            });
            processed.add(words[j]); // マッチした単語を処理済みに追加
          }
        }

        if (matchGroup.length > 1) {
          results.push(matchGroup);
        }
      }

      return results;
    }

    // 2つの単語がずらしで一致するか判定し、シフト量を返す
    function canShift(word1, word2) {
      if (word1.length !== word2.length) return null;

      // 各シフト量をテスト（-15〜+15）
      for (let shift = 1; shift <= 15; shift++) {
        if (shiftWord(word1, shift) === word2) {
          return shift;
        }
        if (shiftWord(word1, -shift) === word2) {
          return -shift;
        }
      }

      return null;
    }

    // 単語全体をシフト
    function shiftWord(word, shift) {
      let result = '';
      for (let i = 0; i < word.length; i++) {
        // 長音記号「ー」はそのまま
        if (word[i] === 'ー') {
          result += 'ー';
          continue;
        }

        const nextChar = shiftHiragana(word[i], shift);
        if (nextChar === null) {
          return null; // シフトできない場合はnull
        }
        result += nextChar;
      }
      return result;
    }

    // 単一ひらがなを指定数ずらす（グループ内でのみずらす）
    function shiftHiragana(char, shift) {
      // どのグループに属するか判定
      let group = null;
      let index = -1;

      if (seion.includes(char)) {
        group = seion;
        index = seion.indexOf(char);
      } else if (dakuon1.includes(char)) {
        group = dakuon1;
        index = dakuon1.indexOf(char);
      } else if (dakuon2.includes(char)) {
        group = dakuon2;
        index = dakuon2.indexOf(char);
      } else if (handakuon.includes(char)) {
        group = handakuon;
        index = handakuon.indexOf(char);
      } else if (chiisai.includes(char)) {
        group = chiisai;
        index = chiisai.indexOf(char);
      } else {
        return char; // 該当なしはそのまま
      }

      const newIndex = index + shift;
      
      // グループ範囲外ならnull（ずらせない）
      if (newIndex < 0 || newIndex >= group.length) {
        return null;
      }
      
      return group[newIndex];
    }

    // 結果を表示
    function displayResults(matches, length) {
      const container = document.getElementById('resultContent');
      
      if (matches.length === 0) {
        container.innerHTML = 
          `<p>${length}文字の単語で一致するペアは見つかりませんでした。</p>`;
        return;
      }

      let html = `<p>マッチ数: ${matches.length}グループ</p>`;
      
      for (let i = 0; i < matches.length; i++) {
        const group = matches[i];
        html += `<div class="match-group">`;
        html += `<div class="match-title">グループ ${i + 1} (${group.length}単語)</div>`;
        html += `<div class="match-list">`;
        
        for (const item of group) {
          html += `<div class="word-item">`;
          html += `<strong>${item.word}</strong>`;
          
          if (item.shift !== 0) {
            const direction = item.shift > 0 ? '下' : '上';
            const amount = Math.abs(item.shift);
            html += `<span class="shift-info">← ${item.base} から${direction}に${amount}ずらし</span>`;
          } else {
            html += `<span class="shift-info">(基準単語)</span>`;
          }
          
          html += `</div>`;
        }
        
        html += `</div></div>`;
      }

      container.innerHTML = html;
    }
  </script>
</body>
</html>
